<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WASM Test Runner</title>
        <style>
            body {
                font-family: 'Courier New', monospace;
                margin: 20px;
                background-color: #1e1e1e;
                color: #d4d4d4;
            }

            h1 {
                color: #4a9eff;
            }

            #output {
                background-color: #252526;
                border: 1px solid #3e3e42;
                padding: 15px;
                border-radius: 4px;
                white-space: pre-wrap;
                font-size: 14px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .pass {
                color: #4ec9b0;
            }

            .fail {
                color: #f48771;
            }

            .run {
                color: #dcdcaa;
            }

            #status {
                margin: 10px 0;
                padding: 10px;
                border-radius: 4px;
                font-weight: bold;
            }

            .loading {
                background-color: #264f78;
            }

            .success {
                background-color: #0e6b0e;
            }

            .error {
                background-color: #5a1d1d;
            }
        </style>
    </head>

    <body>
        <h1>üß™ Megaport CLI WASM Test Runner</h1>
        <div id="status" class="loading">Loading WASM test binary...</div>
        <div id="output"></div>
        <script src="../../web/wasm_exec.js"></script>
        <script>
            const output = document.getElementById('output');
            const status = document.getElementById('status');

            // Capture console output
            const originalLog = console.log;
            const originalError = console.error;

            function appendOutput(text, className = '') {
                const span = document.createElement('span');
                if (className) {
                    span.className = className;
                }
                span.textContent = text + '\n';
                output.appendChild(span);
                output.scrollTop = output.scrollHeight;
            }

            console.log = function (...args) {
                const text = args.join(' ');
                appendOutput(text);
                originalLog.apply(console, args);
            };

            console.error = function (...args) {
                const text = args.join(' ');
                appendOutput(text, 'fail');
                originalError.apply(console, args);
            };

            // Mock DOM elements for localStorage if needed
            if (!window.localStorage) {
                window.localStorage = {
                    getItem: () => null,
                    setItem: () => { },
                    removeItem: () => { },
                    clear: () => { }
                };
            }

            async function runTests() {
                try {
                    appendOutput('üöÄ Initializing Go WASM runtime...\n');

                    const go = new Go();

                    // Load the test binary - use manual fetch due to MIME type issues
                    appendOutput('üì• Fetching WASM test binary...\n');
                    const response = await fetch('wasm.test');

                    if (!response.ok) {
                        throw new Error(`Failed to fetch wasm.test: ${response.status} ${response.statusText}`);
                    }

                    const bytes = await response.arrayBuffer();
                    appendOutput(`‚úÖ Loaded ${(bytes.byteLength / 1024 / 1024).toFixed(2)} MB\n`);

                    appendOutput('üîß Compiling WASM module...\n');
                    const result = await WebAssembly.instantiate(bytes, go.importObject);

                    appendOutput('‚úÖ WASM binary loaded successfully\n');
                    appendOutput('‚ñ∂Ô∏è  Running tests...\n');
                    appendOutput('‚îÄ'.repeat(80) + '\n');

                    // Run the tests
                    go.run(result.instance);

                    // Wait a bit for tests to complete
                    setTimeout(() => {
                        const outputText = output.textContent;
                        if (outputText.includes('FAIL')) {
                            status.textContent = '‚ùå Tests Failed';
                            status.className = 'error';
                        } else if (outputText.includes('PASS') || outputText.includes('ok')) {
                            status.textContent = '‚úÖ All Tests Passed';
                            status.className = 'success';
                        } else {
                            status.textContent = '‚ö†Ô∏è  Tests Completed (check output)';
                            status.className = '';
                        }
                    }, 2000);

                } catch (err) {
                    appendOutput(`\n‚ùå Error: ${err.message}\n`, 'fail');
                    console.error('Full error:', err);
                    status.textContent = '‚ùå Failed to load/run tests';
                    status.className = 'error';
                }
            }

            // Start tests when page loads
            window.addEventListener('load', runTests);
        </script>
    </body>

</html>