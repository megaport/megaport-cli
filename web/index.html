<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>Megaport CLI Web Terminal</title>
        <!-- XTerm.js CSS from CDN -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
        <style>
            body {
                background-color: #000;
                color: #33ff33;
                font-family: monospace;
                margin: 0;
                padding: 0;
                height: 100vh;
                overflow: hidden;
            }

            #login-screen {
                max-width: 500px;
                margin: 50px auto;
                padding: 30px;
                background-color: #111;
                border: 2px solid #33ff33;
                border-radius: 5px;
            }

            #login-screen h2 {
                margin-top: 0;
                color: #33ff33;
            }

            #login-screen input,
            #login-screen select {
                width: 100%;
                padding: 10px;
                margin: 10px 0;
                background-color: #222;
                border: 1px solid #33ff33;
                color: #33ff33;
                font-family: monospace;
                box-sizing: border-box;
            }

            #login-screen button {
                width: 100%;
                padding: 12px;
                margin-top: 15px;
                background-color: #33ff33;
                color: #000;
                border: none;
                font-family: monospace;
                font-weight: bold;
                cursor: pointer;
                font-size: 1.1em;
            }

            #login-screen button:hover {
                background-color: #22cc22;
            }

            #login-screen button:disabled {
                background-color: #666;
                cursor: not-allowed;
            }

            .error-msg {
                color: #ff3333;
                margin-top: 10px;
            }

            #terminal-container {
                display: none;
                height: 100vh;
            }

            #terminal-container.active {
                display: flex;
                flex-direction: column;
            }

            .info-banner {
                background-color: #222;
                color: #33ff33;
                padding: 5px 10px;
                font-size: 0.9em;
                border-bottom: 1px solid #33ff33;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #logout-btn {
                padding: 5px 15px;
                background-color: #ff3333;
                color: #fff;
                border: none;
                cursor: pointer;
                font-family: monospace;
                font-weight: bold;
                font-size: 0.85em;
            }

            #logout-btn:hover {
                background-color: #cc2222;
            }

            #terminal {
                flex: 1;
                padding: 10px;
                overflow: hidden;
            }
        </style>
    </head>

    <body>
        <!-- Login Screen -->
        <div id="login-screen">
            <h2>üîê Megaport CLI Login</h2>
            <p style="color: #888;">Enter your Megaport API credentials to continue</p>
            <label for="access-key">Access Key:</label>
            <input type="text" id="access-key" placeholder="Your access key" />
            <label for="secret-key">Secret Key:</label>
            <input type="password" id="secret-key" placeholder="Your secret key" />
            <label for="environment">Environment:</label>
            <select id="environment">
                <option value="production">Production</option>
                <option value="staging">Staging</option>
                <option value="development">Development</option>
            </select>
            <button id="login-btn">Login</button>
            <div id="login-error" class="error-msg"></div>
        </div>
        <!-- Terminal Container (hidden until logged in) -->
        <div id="terminal-container">
            <div class="info-banner">
                <span>üöÄ Megaport CLI Web Terminal</span>
                <button id="logout-btn">Logout</button>
            </div>
            <div id="terminal"></div>
        </div>
        <!-- Load WASM runtime -->
        <script src="wasm_exec.js"></script>
        <script src="session.js"></script>
        <script src="script.js"></script>
        <!-- XTerm.js Library and Addons from CDN (UMD modules - load before ES6 module) -->
        <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.js"></script>
        <!-- XTerm.js Integration Module -->
        <script type="module">
            import { xtermManager } from './xterm-terminal.js';

            // Make xterm manager globally accessible
            window.xtermManager = xtermManager;

            // Login handling function
            async function handleLogin() {
                const accessKey = document.getElementById('access-key').value.trim();
                const secretKey = document.getElementById('secret-key').value.trim();
                const environment = document.getElementById('environment').value;
                const errorDiv = document.getElementById('login-error');
                const loginBtn = document.getElementById('login-btn');

                if (!accessKey || !secretKey) {
                    errorDiv.textContent = 'Please enter both access key and secret key';
                    return;
                }

                errorDiv.textContent = '';
                loginBtn.disabled = true;
                loginBtn.textContent = 'Logging in...';

                try {
                    await window.loginToMegaport(accessKey, secretKey, environment);

                    // Hide login, show terminal
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('terminal-container').classList.add('active');

                    // Initialize xterm.js terminal
                    const terminalElement = document.getElementById('terminal');
                    xtermManager.init(terminalElement);

                    // Write welcome message
                    xtermManager.writeSuccess('‚úÖ Logged in successfully');
                    xtermManager.writeInfo('Megaport CLI Web Terminal ready');
                    xtermManager.writeInfo('Type a command and press Enter. Use Ctrl+L to clear screen.');
                    xtermManager.writePrompt();

                    // Start session timer
                    updateSessionTimer();
                    setInterval(updateSessionTimer, 1000);

                    // Focus terminal
                    xtermManager.focus();
                } catch (error) {
                    errorDiv.textContent = error.message;
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login';
                }
            }

            // Logout handling function
            async function handleLogout() {
                await window.logoutFromMegaport();
                location.reload();
            }

            function checkSessionExpiration() {
                const remaining = window.sessionManager.getTimeRemaining();
                if (remaining <= 0) {
                    if (xtermManager.initialized) {
                        xtermManager.writeError('‚ö†Ô∏è  Session expired. Redirecting to login...');
                    }
                    window.sessionManager.clearSession();
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }
            }

            // Global handler for session expiration during API calls
            window.onSessionExpired = function () {
                if (xtermManager.initialized) {
                    xtermManager.writeError('‚ö†Ô∏è  Session expired. Please login again.');
                }
                setTimeout(() => {
                    location.reload();
                }, 1500);
            };

            // Attach event listeners
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            // Allow Enter key to submit login
            document.getElementById('secret-key').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // Check if already logged in and verify with server
            async function initializeSession() {
                if (window.sessionManager && window.sessionManager.isValid()) {
                    const isValid = await window.verifySessionOnLoad();

                    if (isValid) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('terminal-container').classList.add('active');

                        // Initialize xterm.js terminal
                        const terminalElement = document.getElementById('terminal');
                        xtermManager.init(terminalElement);

                        xtermManager.writeSuccess('‚úÖ Session restored');
                        xtermManager.writeInfo('Megaport CLI Web Terminal ready');
                        xtermManager.writePrompt();

                        // Check for session expiration every 10 seconds
                        setInterval(checkSessionExpiration, 10000);

                        xtermManager.focus();
                    } else {
                        document.getElementById('login-screen').style.display = 'block';
                        document.getElementById('terminal-container').classList.remove('active');
                    }
                }
            }

            // Load WASM module
            if (typeof go === 'undefined') {
                console.error('Go WASM runtime not initialized by script.js');
            }

            WebAssembly.instantiateStreaming(fetch("megaport.wasm"), go.importObject)
                .then((result) => {
                    console.log("WASM module loaded successfully");
                    go.run(result.instance);

                    // Check if executeMegaportCommand is available
                    if (typeof window.executeMegaportCommand !== 'function' && typeof window.executeMegaportCommandAsync !== 'function') {
                        console.error("Command execution functions not found");
                    }

                    // Initialize session after WASM is loaded
                    initializeSession();
                })
                .catch(err => {
                    console.error("WASM load error:", err);
                    document.getElementById('login-error').textContent = 'Failed to load WASM module: ' + err.message;
                });

            console.log('‚úÖ XTerm.js integration loaded');
        </script>
    </body>

</html>